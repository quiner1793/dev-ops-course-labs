# Kubernetes StatefulSet

## StatefulSet Exploration and Optimization

### Get kubectl info

```shell
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl get po,sts,svc,pvc
NAME                      READY   STATUS    RESTARTS   AGE
pod/python-python-app-0   1/1     Running   0          3m55s
pod/python-python-app-1   1/1     Running   0          3m45s
pod/python-python-app-2   1/1     Running   0          3m33s

NAME                                 READY   AGE
statefulset.apps/python-python-app   3/3     3m56s

NAME                        TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
service/kubernetes          ClusterIP      10.96.0.1      <none>        443/TCP          10m
service/python-python-app   LoadBalancer   10.101.60.78   <pending>     8080:31110/TCP   3m56s

NAME                                                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/config-volume-python-python-app-0   Bound    pvc-1cf6be0f-27c6-4845-99f0-66119daa1d0a   1Gi        RWO            standard       8m24s
persistentvolumeclaim/config-volume-python-python-app-1   Bound    pvc-a7c3c11c-e15b-4bb9-8aaa-f53d12958459   1Gi        RWO            standard       3m45s
persistentvolumeclaim/config-volume-python-python-app-2   Bound    pvc-944933e3-5521-4de1-a935-f1d6b778f26f   1Gi        RWO            standard       3m33s
```

### Check minikube service

```shell
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ minikube service python-python-app
|-----------|-------------------|-------------|---------------------------|
| NAMESPACE |       NAME        | TARGET PORT |            URL            |
|-----------|-------------------|-------------|---------------------------|
| default   | python-python-app | http/8080   | http://192.168.49.2:31110 |
|-----------|-------------------|-------------|---------------------------|
🎉  Opening service default/python-python-app in default browser...
```

### Check statefulset

```shell
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl describe sts python
Name:               python-python-app
Namespace:          default
CreationTimestamp:  Tue, 28 Nov 2023 17:26:56 +0300
Selector:           app.kubernetes.io/instance=python,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/version=0.1.0
Labels:             app.kubernetes.io/instance=python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=0.1.0
Annotations:        meta.helm.sh/release-name: python
                    meta.helm.sh/release-namespace: default
Replicas:           3 desired | 3 total
Update Strategy:    RollingUpdate
  Partition:        0
Pods Status:        3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:           app.kubernetes.io/instance=python
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/version=0.1.0
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-config.txt: internal/data/server/config
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   python-app:
    Image:      quiner/app-python:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:8080/healthcheck delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:8080/healthcheck delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      MY_PASSWORD:     <set to the key 'password' in secret 'credentials'>              Optional: false
      CONFIG_MAP_VAR:  <set to the key 'env-var' of config map 'python-app-configmap'>  Optional: false
      RELEASE_NAME:    python
      SLEEP_TIME:      5
    Mounts:
      /app/config_map from config-volume (rw)
      /app/data from visits-data (rw)
  Volumes:
   config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      python-app-configmap
    Optional:  false
   visits-data:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  500Mi
Volume Claims:
  Name:          visits-data
  StorageClass:  
  Labels:        <none>
  Annotations:   <none>
  Capacity:      1Gi
  Access Modes:  [ReadWriteOnce]
Events:
  Type    Reason            Age    From                    Message
  ----    ------            ----   ----                    -------
  Normal  SuccessfulCreate  8m5s   statefulset-controller  create Claim visits-data-python-python-app-0 Pod python-python-app-0 in StatefulSet python-python-app success
  Normal  SuccessfulCreate  8m5s   statefulset-controller  create Pod python-python-app-0 in StatefulSet python-python-app successful
  Normal  SuccessfulCreate  7m53s  statefulset-controller  create Claim visits-data-python-python-app-1 Pod python-python-app-1 in StatefulSet python-python-app success
  Normal  SuccessfulCreate  7m53s  statefulset-controller  create Pod python-python-app-1 in StatefulSet python-python-app successful
  Normal  SuccessfulCreate  7m41s  statefulset-controller  create Claim visits-data-python-python-app-2 Pod python-python-app-2 in StatefulSet python-python-app success
  Normal  SuccessfulCreate  7m41s  statefulset-controller  create Pod python-python-app-2 in StatefulSet python-python-app successful
```

### Check visits file

Firstly, I accessed my app from different tabs and modes in your browser.

After it, I accessed the visits file:

```shell
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl exec pod/python-python-app-0 -- cat data/visits.txt
4
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl exec pod/python-python-app-1 -- cat data/visits.txt
1
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl exec pod/python-python-app-2 -- cat data/visits.txt
22 
```

### Results

Because each pod has its own persistent volume and the service balancer cannot ensure perfect balance between them, the number of visits varies amongst pods.

### Ordering Guarantee

StatefulSet apps do not require ordering guarantees because the StatefulSet itself ensures that each of its pods has a unique identity and consistent network identification. As a result, the pods can retrieve their previous state from storage and continue their operations even if they are rescheduled on different nodes. Therefore, the StatefulSet's maintenance of pod order and uniqueness makes ordering guarantees unnecessary for the proper functioning of stateful applications.

### Implement a way to instruct the StatefulSet controller to launch or terminate all Pods in parallel

Add `spec.podManagementPolicy: Parallel` in `statefulset.yaml`  

## Bonus App

### Apply same steps as for main app

```shell
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl get po,sts,svc,pvc
NAME                      READY   STATUS    RESTARTS   AGE
pod/go-go-app-0           1/1     Running   0          27s
pod/go-go-app-1           1/1     Running   0          27s
pod/go-go-app-2           1/1     Running   0          27s
pod/python-python-app-0   1/1     Running   0          8m7s
pod/python-python-app-1   1/1     Running   0          8m7s
pod/python-python-app-2   1/1     Running   0          8m7s

NAME                                 READY   AGE
statefulset.apps/go-go-app           3/3     27s
statefulset.apps/python-python-app   3/3     8m7s

NAME                        TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
service/go-go-app           LoadBalancer   10.101.72.185    <pending>     8070:30245/TCP   27s
service/kubernetes          ClusterIP      10.96.0.1        <none>        443/TCP          83m
service/python-python-app   LoadBalancer   10.104.181.236   <pending>     8080:31636/TCP   8m7s

NAME                                                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/config-volume-python-python-app-0   Bound    pvc-1cf6be0f-27c6-4845-99f0-66119daa1d0a   1Gi        RWO            standard       81m
persistentvolumeclaim/config-volume-python-python-app-1   Bound    pvc-a7c3c11c-e15b-4bb9-8aaa-f53d12958459   1Gi        RWO            standard       77m
persistentvolumeclaim/config-volume-python-python-app-2   Bound    pvc-944933e3-5521-4de1-a935-f1d6b778f26f   1Gi        RWO            standard       77m
persistentvolumeclaim/go-visits-data-go-go-app-0          Bound    pvc-7141cc08-a91b-4f34-a270-780a8cb13b58   1Gi        RWO            standard       27s
persistentvolumeclaim/go-visits-data-go-go-app-1          Bound    pvc-b9b08e56-fb10-4ddb-ad19-8ab131391964   1Gi        RWO            standard       27s
persistentvolumeclaim/go-visits-data-go-go-app-2          Bound    pvc-de063b4b-43fc-4d1f-a49a-4be17c1e7709   1Gi        RWO            standard       27s
persistentvolumeclaim/visits-data-python-python-app-0     Bound    pvc-a92bc1e4-6efa-4033-b8ac-5e2efbc9d2de   1Gi        RWO            standard       47m
persistentvolumeclaim/visits-data-python-python-app-1     Bound    pvc-3741a0bb-4f87-4b27-9069-aa0d07cff32b   1Gi        RWO            standard       47m
persistentvolumeclaim/visits-data-python-python-app-2     Bound    pvc-8d1c3841-1b15-4507-8a7c-e0357230dc5d   1Gi        RWO            standard       46m
```

```shell
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ minikube service go-go-app
|-----------|-----------|-------------|---------------------------|
| NAMESPACE |   NAME    | TARGET PORT |            URL            |
|-----------|-----------|-------------|---------------------------|
| default   | go-go-app | http/8070   | http://192.168.49.2:31895 |
|-----------|-----------|-------------|---------------------------|
🎉  Opening service default/go-go-app in default browser...
```

```shell
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl exec pod/go-go-app-0 -- cat data/visits.txt
2
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl exec pod/go-go-app-1 -- cat data/visits.txt
4
quiner@quiner-MaiBook-X-series:~/innopolis/dev-ops-course-labs/k8s$ kubectl exec pod/go-go-app-2 -- cat data/visits.txt
11
```

### Explore Update Strategies

Source: <https://spot.io/resources/kubernetes-autoscaling/5-kubernetes-deployment-strategies-roll-out-like-the-pros/>

* Rolling deployment—the default strategy that allows you to update a set of pods without downtime. It replaces pods running the old version of the application with the new version, one by one.
* Recreate deployment—an all-or-nothing method that lets you update an application instantly, with some downtime. It terminates all pods and replaces them with the new version.
* Ramped slow rollout—rolls out replicas of the new version, while in parallel, shutting down old replicas.
* Best-effort controlled rollout—specifies a “max unavailable” parameter which indicates what percentage of existing pods can be unavailable during the upgrade, enabling the rollout to happen much more quickly.
* Blue/green deployment—a deployment strategy in which you create two separate, but identical environments, and over to the new environment.
* Canary deployment—uses a progressive delivery approach, with one version of the application serving most users, and another, newer version serving a small pool of test users. The test deployment is rolled out to more users if it is successful.
* Shadow deployment—the new version of the application (the “shadow” version) receives real-world traffic alongside the current version, but without affecting end-users.
* A/B testing—rolls out two or more versions of an application feature to a subset of users simultaneously to see which one performs better in terms of user engagement, error rates, or other KPIs.
